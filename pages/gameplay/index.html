<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –°–µ–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ */
    /* ... */
</style>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // SocketHandler
        class SocketHandler {
            constructor() {
                this.socket = null;
                this.messageHandler = null;
            }

            init(playerId, messageHandler) {
                if (!playerId) {
                    console.warn("Player ID not provided - running in demo mode");
                    return;
                }

                this.messageHandler = messageHandler;
                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const host = window.location.host || 'localhost:8080';
                this.socket = new WebSocket(`${protocol}${host}/ws/${playerId}`);

                this.setupEventHandlers();
            }

            setupEventHandlers() {
                this.socket.onopen = () => {
                    console.log("WebSocket connected");
                    this.send('player_connected');
                };

                this.socket.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.messageHandler?.(message);
                    } catch (e) {
                        console.error("Error parsing message:", e);
                    }
                };

                this.socket.onclose = () => {
                    console.log("WebSocket disconnected");
                    this.messageHandler?.({ type: 'error', text: '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ' });
                };

                this.socket.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    this.messageHandler?.({ type: 'error', text: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' });
                };
            }

            send(action, data = {}) {
                if (this.socket?.readyState === WebSocket.OPEN) {
                    this.socket.send(JSON.stringify({ action, ...data }));
                } else {
                    console.warn("WebSocket not ready");
                }
            }
        }

        // GameController
        class GameController {
            constructor(uiManager, socketHandler) {
                this.ui = uiManager;
                this.socket = socketHandler;
                this.currentPlayerId = null;
                this.gameState = {
                    bankAmount: 0,
                    currentTurn: "–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...",
                    players: []
                };
                this.isTelegram = false;
                this.demoInterval = null;
            }

            async init() {
                this.detectEnvironment();
                this.ui.setController(this);

                if (this.isTelegram) {
                    this.initTelegramUser();
                    this.ui.setExitHandler(() => Telegram.WebApp.close());
                } else {
                    this.initDemoUser();
                    this.ui.setExitHandler(() => {
                        if (this.demoInterval) clearInterval(this.demoInterval);
                        window.close();
                    });
                }

                try {
                    await this.connectToGame();
                    this.ui.initUI();
                } catch (error) {
                    this.ui.showError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–≥—Ä–µ");
                    console.error("Game init error:", error);
                }
            }

            detectEnvironment() {
                this.isTelegram = !!(window.Telegram && Telegram.WebApp);
            }

            initTelegramUser() {
                const tgUser = Telegram.WebApp.initDataUnsafe?.user;
                if (tgUser) {
                    this.currentPlayerId = tgUser.id.toString();
                    this.ui.setCurrentPlayer({
                        id: this.currentPlayerId,
                        first_name: tgUser.first_name || `–ò–≥—Ä–æ–∫ ${tgUser.id}`,
                        photo_url: tgUser.photo_url
                    });
                    Telegram.WebApp.expand();
                }
            }

            initDemoUser() {
                this.currentPlayerId = "1";
                this.ui.setCurrentPlayer({
                    id: "1",
                    first_name: "–í—ã (–¥–µ–º–æ)",
                    photo_url: null
                });
                this.startDemoMode();
            }

            startDemoMode() {
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                this.updateGameState({
                    bankAmount: 1250,
                    currentTurn: "–í–∞—à —Ö–æ–¥",
                    players: Array.from({length: 6}, (_, i) => ({
                        id: (i + 1).toString(),
                        first_name: i === 0 ? "–í—ã (–¥–µ–º–æ)" : `–ò–≥—Ä–æ–∫ ${i + 1}`,
                        balance: 1000 + Math.floor(Math.random() * 2000),
                        action: i === 0 ? "–í–∞—à —Ö–æ–¥" : ["–û–∂–∏–¥–∞–Ω–∏–µ", "–°—Ç–∞–≤–∫–∞", "–ü–∞—Å"][Math.floor(Math.random() * 3)],
                        is_current: i === 0,
                        photo_url: null
                    }))
                });

                // –ò–º–∏—Ç–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
                this.demoInterval = setInterval(() => {
                    const newBank = this.gameState.bankAmount + Math.floor(Math.random() * 100);
                    const currentPlayerIndex = Math.floor(Math.random() * 6);

                    this.updateGameState({
                        bankAmount: newBank,
                        currentTurn: currentPlayerIndex === 0 ? "–í–∞—à —Ö–æ–¥" : `–•–æ–¥ –ò–≥—Ä–æ–∫–∞ ${currentPlayerIndex + 1}`,
                        players: this.gameState.players.map((p, i) => ({
                            ...p,
                            action: i === currentPlayerIndex ? "–î—É–º–∞–µ—Ç..." :
                                   ["–û–∂–∏–¥–∞–Ω–∏–µ", "–°—Ç–∞–≤–∫–∞", "–ü–∞—Å"][Math.floor(Math.random() * 3)],
                            is_current: i === currentPlayerIndex,
                            balance: i === currentPlayerIndex ? p.balance - 50 : p.balance
                        }))
                    });
                }, 5000);
            }

            async connectToGame() {
                if (this.isTelegram) {
                    this.socket.init(this.currentPlayerId, this.handleSocketMessage.bind(this));
                }
            }

            handleSocketMessage(message) {
                switch (message.type) {
                    case 'game_state':
                        this.updateGameState(message.data);
                        break;
                    case 'player_update':
                        this.updatePlayer(message.data);
                        break;
                    case 'error':
                        this.ui.showError(message.text);
                        break;
                    default:
                        console.log("Unknown message type:", message.type);
                }
            }

            updateGameState(state) {
                this.gameState = {
                    ...this.gameState,
                    ...state,
                    players: state.players || this.gameState.players
                };
                this.ui.updateGameState(this.gameState);
            }

            updatePlayer(playerData) {
                this.ui.updatePlayer(playerData);
            }

            placeBet(amount) {
                if (this.isTelegram) {
                    this.socket.send('place_bet', { amount });
                } else {
                    this.ui.showError(`–°—Ç–∞–≤–∫–∞ ${amount} (–≤ Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞)`);
                    this.updateGameState({
                        players: this.gameState.players.map(p =>
                            p.id === this.currentPlayerId
                                ? { ...p, action: "–°—Ç–∞–≤–∫–∞", balance: p.balance - amount }
                                : p
                        )
                    });
                }
            }

            fold() {
                if (this.isTelegram) {
                    this.socket.send('fold', {});
                } else {
                    this.ui.showError("–ü–∞—Å (–≤ Telegram –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω)");
                    this.updateGameState({
                        players: this.gameState.players.map(p =>
                            p.id === this.currentPlayerId
                                ? { ...p, action: "–ü–∞—Å" }
                                : p
                        )
                    });
                }
            }
        }

        // React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        function getRandomColor() {
            const colors = ['#FF5733', '#33FF57', '#3357FF', '#F333FF', '#33FFF3'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getActionColor(action) {
            const colors = {
                '–°—Ç–∞–≤–∫–∞': 'rgba(76, 175, 80, 0.3)',
                '–ü–∞—Å': 'rgba(244, 67, 54, 0.3)',
                '–î—É–º–∞–µ—Ç...': 'rgba(255, 235, 59, 0.3)',
                '–í–∞—à —Ö–æ–¥': 'rgba(33, 150, 243, 0.3)',
                'default': 'rgba(0, 0, 0, 0.3)'
            };
            return colors[action] || colors.default;
        }

        function PlayerCard({ player, isCurrent }) {
            const avatarStyle = player.photo_url
                ? { backgroundImage: `url(${player.photo_url})` }
                : {
                    backgroundColor: getRandomColor(),
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                };

            return (
                <div className={`player-card ${isCurrent ? 'current-player active' : ''}`}>
                    <div className="player-avatar" style={avatarStyle}>
                        {!player.photo_url && (player.first_name?.[0] || '?')}
                    </div>
                    <div className="player-action" style={{ backgroundColor: getActionColor(player.action) }}>
                        {player.action || '–û–∂–∏–¥–∞–Ω–∏–µ'}
                    </div>
                    <div className="player-name">{player.first_name}</div>
                    <div className="player-balance">$ {player.balance?.toLocaleString('ru-RU') || '0'}</div>
                </div>
            );
        }
        function App() {
            const [menuOpen, setMenuOpen] = React.useState(false);
            const [gameState, setGameState] = React.useState({
                bankAmount: 0,
                currentTurn: "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...",
                players: []
            });
            const [currentPlayer, setCurrentPlayer] = React.useState(null);
            const [showActions, setShowActions] = React.useState(false);
            const [error, setError] = React.useState(null);

            const controllerRef = React.useRef(null);
            const socketRef = React.useRef(null);

            React.useEffect(() => {
                const uiManager = {
                    setController: (controller) => {
                        controllerRef.current = controller;
                    },
                    setExitHandler: (handler) => {
                        const exitButton = document.querySelector('.exit-button');
                        if (exitButton) {
                            exitButton.onclick = handler;
                        }
                    },
                    setCurrentPlayer: (player) => {
                        setCurrentPlayer(player);
                    },
                    initUI: () => {
                        console.log("UI initialized");
                    },
                    updateGameState: (state) => {
                        setGameState(state);
                        const isCurrentPlayer = state.players.some(p =>
                            p.is_current && p.id === currentPlayer?.id
                        );
                        setShowActions(isCurrentPlayer);
                    },
                    updatePlayer: (playerData) => {
                        setGameState(prev => ({
                            ...prev,
                            players: prev.players.map(p =>
                                p.id === playerData.id ? { ...p, ...playerData } : p
                            )
                        }));
                    },
                    showError: (message) => {
                        setError(message);
                        setTimeout(() => setError(null), 3000);
                    }
                };

                socketRef.current = new SocketHandler();
                const controller = new GameController(uiManager, socketRef.current);
                controller.init();

                return () => {
                    if (socketRef.current?.socket) {
                        socketRef.current.socket.close();
                    }
                };
            }, []);

            const handleBet = () => {
                const amount = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏:", "10");
                if (amount && !isNaN(amount)) {
                    controllerRef.current?.placeBet(parseInt(amount));
                }
            };

            const handleFold = () => {
                if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—ã?")) {
                    controllerRef.current?.fold();
                }
            };

            return (
                <div className="main-area">
                    <button className="menu-button" onClick={() => setMenuOpen(!menuOpen)}>‚ò∞</button>

                    <div className="center-block">
                        <div className="player-turn-info">
                            {gameState.currentTurn}
                        </div>
                    </div>

                    <div className="top-right-buttons">
                        <button className="sound-button">üîä</button>
                        <button className="exit-button">‚úï</button>
                    </div>

                    {menuOpen && (
                        <div className="dropdown-menu" onClick={() => setMenuOpen(false)}>
                            <a href="#">üìú–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</a>
                            <a href="#">üìä–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</a>
                            <a href="#">üë•–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</a>
                        </div>
                    )}

                    <div className="game-title">–°–µ–∫–∞</div>

                    <div className="players-container">
                        <div className="players-left">
                            {gameState.players.slice(0, 3).map((player) => (
                                <PlayerCard
                                    key={player.id}
                                    player={player}
                                    isCurrent={player.is_current}
                                />
                            ))}
                        </div>
                        <div className="players-right">
                            {gameState.players.slice(3, 6).map((player) => (
                                <PlayerCard
                                    key={player.id}
                                    player={player}
                                    isCurrent={player.is_current}
                                />
                            ))}
                        </div>
                    </div>

                    <div className="bank-title">–ë–∞–Ω–∫</div>
                    <div className="bank-amount">$ {gameState.bankAmount.toLocaleString('ru-RU')}</div>

                    <div className="bottom-panel"></div>

                    {showActions && (
                        <>
                            <button
                                className="action-button"
                                style={{ left: 'calc(50% - 120px)', backgroundColor: '#4CAF50' }}
                                onClick={handleBet}
                            >
                                –°—Ç–∞–≤–∫–∞
                            </button>
                            <button
                                className="action-button"
                                style={{ left: 'calc(50% + 20px)', backgroundColor: '#F44336' }}
                                onClick={handleFold}
                            >
                                –ü–∞—Å
                            </button>
                        </>
                    )}

                    {error && (
                        <div className="error-message">
                            {error}
                        </div>
                    )}
                </div>
            );
        }


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            const rootElement = document.getElementById('root');
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        });
    </script>
</body>
</html>