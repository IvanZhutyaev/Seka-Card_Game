<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СЕКА - Карточная игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/js/telegram-utils.js"></script>
    <script src="/static/js/common.js"></script>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/gameplay/styles.css">
</head>
<body>
    <div id="app">
        <div id="game-table">
            <div id="opponent-area"></div>
            <div id="table-center">
                <div id="bank">Банк: <span>0</span></div>
                <div id="current-bet">Текущая ставка: <span>0</span></div>
            </div>
            <div id="player-area">
                <div id="player-cards"></div>
                <div id="player-actions">
                    <button id="fold-btn" disabled>Пас</button>
                    <div id="bet-controls">
                        <input type="number" id="bet-amount" min="100" max="2000" step="100" value="100" disabled>
                        <button id="bet-btn" disabled>Ставка</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameSocket;
        let gameState;

        async function initGame() {
            try {
                TelegramUtils.showLoading();

                // Проверяем инициализацию WebApp
                if (!window.Telegram?.WebApp) {
                    throw new Error('WebApp не инициализирован');
                }

                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                await new Promise(resolve => setTimeout(resolve, 500));

                // Проверяем данные пользователя
                const initData = window.Telegram.WebApp.initData;
                const user = window.Telegram.WebApp.initDataUnsafe?.user;

                if (!initData || !user?.id) {
                    throw new Error('Отсутствуют данные инициализации');
                }

                // Проверяем валидность сессии
                const isValid = await TelegramUtils.validateSession();
                if (!isValid) {
                    throw new Error('Невалидная сессия');
                }

                // Проверяем параметры URL для восстановления игры
                const urlParams = new URLSearchParams(window.location.search);
                const shouldResume = urlParams.get('resume') === 'true';

                if (shouldResume) {
                    // Пытаемся восстановить состояние игры
                    const response = await API.get('/api/game/state');
                    
                    if (response.status === 'active') {
                        gameState = response.state;
                        GameState.save(gameState);
                        
                        // Инициализируем WebSocket
                        gameSocket = new GameSocket(response.game_id);
                        setupEventHandlers();
                        gameSocket.connect();
                        
                        // Обновляем UI
                        updateGameState(gameState);
                        return;
                    }
                }

                // Создаем новую игру
                const createResponse = await API.post('/api/game/create');
                
                switch (createResponse.status) {
                    case 'game_created':
                        gameState = {
                            gameId: createResponse.game_id,
                            players: createResponse.players,
                            currentPlayer: createResponse.players[0],
                            bank: 0,
                            currentBet: 0,
                            playerCards: []
                        };
                        GameState.save(gameState);
                        
                        // Инициализируем WebSocket
                        gameSocket = new GameSocket(createResponse.game_id);
                        setupEventHandlers();
                        gameSocket.connect();
                        break;
                        
                    case 'waiting':
                        // Показываем экран ожидания
                        showWaitingScreen(createResponse.players_count, createResponse.required_players);
                        break;
                        
                    case 'active_game_exists':
                        // Спрашиваем пользователя, хочет ли он вернуться в существующую игру
                        const confirmed = await TelegramUtils.showConfirm(
                            'У вас есть активная игра. Хотите вернуться к ней?'
                        );
                        
                        if (confirmed) {
                            window.location.href = `/gameplay/index.html?resume=true`;
                        } else {
                            window.location.href = '/main_menu.html';
                        }
                        break;
                        
                    default:
                        throw new Error('Неизвестный статус создания игры');
                }

            } catch (error) {
                console.error('Ошибка инициализации игры:', error);
                TelegramUtils.hideLoading();
                
                // Более информативное сообщение об ошибке
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Не удалось подключиться к серверу. Проверьте подключение к интернету.';
                } else if (error.message === 'Invalid session') {
                    errorMessage = 'Сессия недействительна. Попробуйте перезапустить приложение.';
                }
                
                TelegramUtils.showAlert(`Ошибка инициализации игры: ${errorMessage}`);
                
                // Даем пользователю время прочитать сообщение перед редиректом
                setTimeout(() => {
                    window.location.href = `${window.location.protocol}//${window.location.hostname}:3000/pages/main_menu.html`;
                }, 3000);
            } finally {
                TelegramUtils.hideLoading();
            }
        }

        function showWaitingScreen(currentPlayers, requiredPlayers) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="waiting-screen">
                    <h2>Ожидание игроков</h2>
                    <p>Игроков в очереди: ${currentPlayers} из ${requiredPlayers}</p>
                    <div class="loader"></div>
                    <button onclick="cancelWaiting()">Отменить</button>
                </div>
            `;
        }

        async function cancelWaiting() {
            try {
                await API.post('/api/game/cancel-waiting');
                window.location.href = '/main_menu.html';
            } catch (error) {
                console.error('Ошибка отмены ожидания:', error);
                TelegramUtils.showAlert('Ошибка отмены ожидания');
            }
        }

        function setupEventHandlers() {
            // Обработчики WebSocket событий
            gameSocket.on('connected', () => {
                console.log('Подключено к игре');
                enableControls();
            });

            gameSocket.on('disconnected', () => {
                console.log('Отключено от игры');
                disableControls();
            });

            gameSocket.on('game_state', (state) => {
                updateGameState(state);
            });

            gameSocket.on('error', (error) => {
                console.error('Ошибка WebSocket:', error);
                TelegramUtils.showAlert('Ошибка соединения');
            });

            gameSocket.on('reconnect_failed', () => {
                TelegramUtils.showAlert('Не удалось восстановить соединение');
                setTimeout(() => {
                    TelegramUtils.openLink('main_menu');
                }, 2000);
            });

            // Обработчики кнопок
            document.getElementById('fold-btn').addEventListener('click', () => {
                TelegramUtils.hapticFeedback('medium');
                gameSocket.send({ action: 'fold' });
            });

            document.getElementById('bet-btn').addEventListener('click', () => {
                const betAmount = document.getElementById('bet-amount').value;
                TelegramUtils.hapticFeedback('medium');
                gameSocket.send({ action: 'bet', amount: parseInt(betAmount) });
            });

            // Обработчик закрытия страницы
            window.addEventListener('beforeunload', () => {
                gameSocket?.close();
                GameState.clear();
            });

            // Обработчик возврата фокуса
            window.addEventListener('focus', async () => {
                try {
                    const isValid = await TelegramUtils.validateSession();
                    if (!isValid) {
                        TelegramUtils.showAlert('Сессия истекла');
                        setTimeout(() => {
                            TelegramUtils.openLink('main_menu');
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Ошибка проверки сессии:', error);
                }
            });
        }

        function enableControls() {
            document.getElementById('fold-btn').disabled = false;
            document.getElementById('bet-amount').disabled = false;
            document.getElementById('bet-btn').disabled = false;
        }

        function disableControls() {
            document.getElementById('fold-btn').disabled = true;
            document.getElementById('bet-amount').disabled = true;
            document.getElementById('bet-btn').disabled = true;
        }

        function updateGameState(state) {
            // Обновляем состояние игры в localStorage
            GameState.update(state);

            // Обновляем UI
            document.querySelector('#bank span').textContent = state.bank;
            document.querySelector('#current-bet span').textContent = state.currentBet;

            // Обновляем карты игрока
            const playerCards = document.getElementById('player-cards');
            playerCards.innerHTML = '';
            state.playerCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.textContent = `${card.rank}${card.suit}`;
                playerCards.appendChild(cardElement);
            });

            // Обновляем состояние кнопок
            const betBtn = document.getElementById('bet-btn');
            const foldBtn = document.getElementById('fold-btn');
            const betInput = document.getElementById('bet-amount');

            if (state.currentPlayer === state.playerId) {
                enableControls();
                betInput.min = state.minBet;
                betInput.max = state.maxBet;
                betInput.value = state.minBet;
            } else {
                disableControls();
            }
        }

        // Инициализируем игру при загрузке страницы
        window.addEventListener('load', initGame);
    </script>
</body>
</html>